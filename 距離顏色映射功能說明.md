# 距離顏色映射功能說明

## 功能概述

本更新為LiDAR控制系統添加了全新的**動態比例尺距離顏色映射**功能，實現了智能的距離顏色可視化方式，替代了原來的百分比變化顏色映射。

## 新的顏色映射規則

### 動態比例尺映射
- **固定顏色順序**：紅色 → 橙色 → 黃色 → 綠色 → 藍色
- **動態區間調整**：顏色區間根據點雲的最大距離自動調整

### 範例說明
**當最大距離為500米時：**
- **0-100米**：紅色
- **100-200米**：橙色  
- **200-300米**：黃色
- **300-400米**：綠色
- **400-500米**：藍色

**當最大距離為1000米時：**
- **0-200米**：紅色
- **200-400米**：橙色
- **400-600米**：黃色
- **600-800米**：綠色
- **800-1000米**：藍色

### 特點
1. **智能適應**：顏色區間自動根據數據的最大距離調整
2. **固定顏色順序**：紅→橙→黃→綠→藍的順序便於記憶和識別
3. **比例尺功能**：支持手動設定最大距離比例尺
4. **一致性解釋**：相同的顏色在不同掃描中具有相對一致的含義

## 新增文件和功能

### 1. 顏色映射器 (`src/data/color_mapper.py`)
- `DistanceColorMapper` 類：核心動態顏色映射邏輯
- 支持自動和手動比例尺調整
- 提供顏色映射設定對話框
- 生成動態顏色對照圖例
- 智能計算最佳顏色區間分佈

### 2. 主窗口更新 (`src/gui/main_window.py`)
- 集成新的顏色映射系統
- 添加右側顏色對照圖例面板
- 新增顏色映射設定菜單選項
- 實時顏色映射刷新功能

### 3. 演示程序 (`color_mapping_demo.py`)
- 獨立的顏色映射演示程序
- 生成測試數據展示新功能
- 包含統計信息和互動控制

## 界面變化

### 主界面更新
1. **可視化面板**：
   - 左側：3D點雲和2D投影圖表
   - 右側：距離顏色對照表

2. **顏色對照表**：
   - 顯示每個距離區間對應的顏色
   - 提供設定和重置按鈕
   - 實時顯示當前映射規則

3. **菜單新增**：
   - 設置 → 顏色映射設置

## 使用方法

### 基本使用
1. 啟動LiDAR控制系統
2. 點雲會自動使用新的固定距離顏色映射
3. 查看右側面板的顏色對照表了解映射規則

### 調整顏色比例尺
1. 點擊"顏色比例尺設定"按鈕
2. 選擇自動模式（根據數據自動調整）或手動模式
3. 手動模式下可設定最大距離（200m、500m、1000m、2000m等）
4. 預覽顏色區間分佈
5. 點擊"應用"確認設定

### 設定顏色映射
1. 點擊右側面板的"設定顏色映射"按鈕
2. 或通過菜單：設置 → 顏色映射設置
3. 在對話框中查看當前映射規則
4. 調整區間數量（3-7個顏色區間）
5. 點擊"重置為預設"恢復預設設定

### 演示程序
```bash
python color_mapping_demo.py
```

## 技術實現

### 核心邏輯
```python
# 距離到顏色索引的映射
def map_distances_to_colors(self, distances):
    colors = np.zeros_like(distances, dtype=int)
    for i, range_info in enumerate(self.color_ranges):
        mask = (distances >= range_info['min']) & (distances < range_info['max'])
        colors[mask] = i
    return colors
```

### 可視化實現
```python
# 使用新的顏色映射繪製點雲
self.color_mapper.plot_distance_colors(
    self.ax1, distances, x, y, z, point_size)
```

## 兼容性

### 向後兼容
- 現有的點雲數據格式完全兼容
- 不影響其他功能的正常使用
- 可以隨時切換回原始顏色映射（如需要）

### 數據格式支持
- 真實掃描數據 (6列以上)
- 測試數據 (極座標格式)
- 載入的點雲文件

## 故障排除

### 常見問題

1. **中文字體顯示問題**
   - 症狀：matplotlib圖表中的中文標籤顯示為方塊或警告
   - 解決：matplotlib會自動使用可用字體，功能不受影響

2. **顏色顯示異常**
   - 檢查距離數據是否正確 (單位：米)
   - 確認顏色映射範圍設定合理

3. **圖例不更新**
   - 重新啟動應用程序
   - 或點擊"重置為預設"按鈕

## 未來擴展

### 計劃功能
1. **可編輯顏色映射**：
   - 自定義距離區間
   - 選擇不同顏色
   - 保存個人化設定

2. **多種映射模式**：
   - 距離映射（當前）
   - 高度映射
   - 反射強度映射

3. **高級可視化**：
   - 顏色條顯示
   - 透明度控制
   - 動態範圍調整

## 技術支持

如有問題或建議，請檢查：
1. 本文檔的故障排除章節
2. 運行演示程序測試功能
3. 查看控制台輸出的錯誤信息

---

*版本：v1.0*  
*更新日期：2024年*  
*作者：LiDAR控制系統開發團隊* 