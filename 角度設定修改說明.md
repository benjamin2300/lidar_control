# LiDAR 角度範圍修改說明

## 修改概要

根據用戶需求，將LiDAR的X軸掃描對應角度從原本的：
- **水平角度**：0~60度 → 改為 **-30~+30度**
- **垂直角度**：0~30度 → 改為 **-15~+15度**

同時保持坐標反轉功能。

## 修改內容

### 1. 數據處理器修改 (`src/data/data_processor.py`)

#### 修改前：
```python
# 垂直角度反轉 - 讓物理上方對應座標上方
y_angles = np.linspace(30, 0, n_lines)  # 改為30°到0°，第1條線=30°，第300條線=0°
```

#### 修改後：
```python
# 垂直角度改為-15°到+15°，讓物理上方對應座標上方
y_angles = np.linspace(15, -15, n_lines)  # 改為15°到-15°，第1條線=15°，第300條線=-15°
```

**說明**：
- 水平角度在 `merge_scan_line` 方法中已經使用 `np.linspace(-30, 30, 600)`，符合要求
- 垂直角度從 30°~0° 改為 15°~-15°，提供對稱的垂直視角

### 2. 控制器功能擴展 (`src/controller/lidar_controller.py`)

#### 新增垂直掃描範圍設定方法：
```python
def set_vertical_scan_range(self, start_angle: int, end_angle: int) -> None:
    """設定垂直掃描範圍 (0x41)"""
    params = start_angle.to_bytes(2, 'big') + end_angle.to_bytes(2, 'big')
    self.send_command(0x41, params)
```

**說明**：
- 補充了原本缺少的垂直掃描範圍控制功能
- 使用指令碼 0x41，符合LiDAR指令集規範
- 角度單位為0.1度，傳送前需要乘以10

### 3. GUI界面增強 (`src/gui/main_window.py`)

#### 新增功能：
1. **角度範圍屬性**：
   ```python
   self.horizontal_range = [-30, 30]  # 水平角度範圍 (度)
   self.vertical_range = [-15, 15]    # 垂直角度範圍 (度)
   ```

2. **角度設定按鈕**：
   - "設定角度範圍" - 開啟角度設定對話框
   - "重置為預設角度" - 重置為新的預設角度範圍

3. **角度設定對話框**：
   - 可輸入水平和垂直角度範圍
   - 自動轉換角度單位並發送到硬體
   - 提供操作日誌記錄

#### 硬體指令發送：
```python
# 發送角度設定指令到硬體（角度單位需要轉換為0.1度）
h_start = int(self.horizontal_range[0] * 10)  # 轉換為0.1度單位
h_end = int(self.horizontal_range[1] * 10)
v_start = int(self.vertical_range[0] * 10)
v_end = int(self.vertical_range[1] * 10)

self.controller.set_scan_range(h_start, h_end)  # 設定水平掃描範圍
self.controller.set_vertical_scan_range(v_start, v_end)  # 設定垂直掃描範圍
```

## 角度範圍對比

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 水平角度範圍 | 0° ~ 60° | -30° ~ +30° |
| 垂直角度範圍 | 0° ~ 30° | -15° ~ +15° |
| 水平視角總範圍 | 60° | 60° (保持不變) |
| 垂直視角總範圍 | 30° | 30° (保持不變) |
| 座標系統 | 非對稱 | 對稱 (以0°為中心) |

## 使用方式

### 設定角度範圍：
1. 點擊 **"設定角度範圍"** 按鈕
2. 在對話框中輸入所需的角度範圍
3. 點擊 **"應用"** 發送到硬體

### 重置為預設：
1. 點擊 **"重置為預設角度"** 按鈕
2. 自動將角度重置為 -30°~+30° (水平) 和 -15°~+15° (垂直)

## 技術細節

### 角度單位轉換：
- GUI輸入：度 (°)
- 硬體傳送：0.1度單位
- 轉換公式：`hardware_value = degree_value * 10`

### 指令碼對應：
- 0x40：設定水平掃描範圍
- 0x41：設定垂直掃描範圍

### 座標映射：
- 維持原有的座標反轉功能
- X軸：前後方向
- Y軸：左右方向  
- Z軸：上下方向

## 優勢

1. **對稱視角**：以0°為中心的對稱角度範圍，更符合直觀操作
2. **完整控制**：提供水平和垂直角度的完整硬體控制功能
3. **用戶友好**：GUI界面直觀，支援自定義和快速重置
4. **向後兼容**：保持原有的數據處理和座標轉換邏輯

## 注意事項

1. 角度設定會直接影響硬體掃描範圍
2. 修改角度後建議重新啟動掃描以確保設定生效
3. 角度範圍設定會在系統日誌中記錄，便於追踪操作
4. 設定錯誤時會在日誌中顯示錯誤信息 