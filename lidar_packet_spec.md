# LiDAR距離封包解析規格文件

## 文件版本：2.0
## 日期：2025-05-30
## 基於實際封包分析結果

本文件詳細定義LiDAR掃描系統的UDP距離封包格式和解析方法。

---

## 1. 概述

LiDAR系統採用UDP協議傳輸掃描數據，每個完整掃描幀包含600×300個距離點。系統使用S型掃描方式，每條Y軸掃描線的600個X軸點分割為兩個UDP封包傳輸。

### 1.1 基本參數
- **掃描方式**: S型掃描
- **點陣大小**: 600(X軸) × 300(Y軸)
- **Y軸角度範圍**: 0-300+
- **傳輸協議**: UDP
- **距離單位**: 厘米(cm)
- **字節序**: Little-endian (除特別註明外)

---

## 2. 網路通訊參數

### 2.1 網路配置
- **源IP**: 192.168.2.10 (LiDAR設備)
- **目標IP**: 192.168.2.194 (接收端)
- **協議**: UDP
- **目標端口**: 8881 (距離數據)
- **目標端口**: 8882 (其他數據)

### 2.2 封包類型
- **"d"封包**: 第一個距離封包 (X軸前300點: 0-299)
- **"e"封包**: 第二個距離封包 (X軸後300點: 300-599)
- **"a"封包**: 強度數據封包 (可忽略)

---

## 3. UDP封包結構

### 3.1 完整封包格式
```
+==================+
| 以太網頭 (14字節)  |
+==================+
| IP頭 (20字節)     |
+==================+  
| UDP頭 (8字節)     |
+==================+
| LiDAR負載數據     |
| (1206字節)       |
+==================+
```

### 3.2 LiDAR負載結構 (1206字節)
```
+====================+===============+================================+
| 欄位名稱           | 大小          | 說明                           |
+====================+===============+================================+
| 幀標識符           | 2字節         | 0xAA55 (little-endian)        |
+--------------------+---------------+--------------------------------+
| 封包類型資訊       | 2字節         | [type(4bit)][y_scan(12bit)]    |
+--------------------+---------------+--------------------------------+
| 距離數據           | 1200字節      | 300點 × 4字節/點               |
+--------------------+---------------+--------------------------------+
| Frame ID          | 2字節         | 幀編號 (little-endian)         |
+====================+===============+================================+
```

---

## 4. 詳細欄位定義

### 4.1 幀標識符 (Bytes 0-1)
- **值**: `0xAA55` (固定值)
- **字節序**: Little-endian
- **用途**: 識別LiDAR數據封包開始

### 4.2 封包類型資訊 (Bytes 2-3)
```
+-------------------+-------------------+
| type (高4 bit)    | y_scan (低4+8bit) |
| 4 bit             | 12 bit            |
+-------------------+-------------------+
```

#### 4.2.1 封包類型 (type)
- 佔第2位元組高4 bit（bits 7~4），代表封包類型。
- 0: d封包（距離數據，X軸前300點）
- 1: e封包（距離數據，X軸後300點）
- 2: a封包（intense強度封包）
- 其他值保留

#### 4.2.2 Y軸掃描順序 (y_scan)
- 佔第2位元組低4 bit（bits 3~0）與第3位元組8 bit，合計12 bit（Little-endian）。
- 解析方式：`y_scan = (data[3] << 4) | (data[2] & 0x0F)`
- 代表Y軸的掃描順序編號。
- 例如：Wireshark封包顯示2c d1，Little-endian解讀為d1 2c，y_scan = 0xd12c。
- y_scan最大值約350，僅作為順序參考。
- 本欄位不直接對應角度，僅供點雲重組時排序。

### 4.3 距離數據 (Bytes 4-1203)
- **總大小**: 1200字節
- **點數**: 300個距離點
- **每點格式**: 4字節 little-endian

#### 4.3.1 距離點格式
```
+-------+-------+-------+-------+
| byte0 | byte1 | byte2 | byte3 |
| LSB   |       |       | MSB   |
+-------+-------+-------+-------+
```

#### 4.3.2 距離值計算
```c
distance_cm = byte0 | (byte1 << 8) | (byte2 << 16) | (byte3 << 24);
```

#### 4.3.3 有效性檢查
- **有效範圍**: 0 < distance_cm < 10000
- **無效值**: 0 或 65535
- **單位**: 厘米(cm)

### 4.4 Frame ID (Bytes 1204-1205)
- **大小**: 2字節
- **字節序**: Little-endian  
- **用途**: 同一Y軸掃描線的d/e封包具有相同Frame ID
- **範圍**: 0-65535

---

## 5. 掃描邏輯

### 5.1 S型掃描方式
```
Y軸 ^
    |
300 +---->---->---->
    |              |
250 +<----<----<---+
    |
200 +---->---->---->
    |              |
150 +<----<----<---+
    |
    +--+--+--+--+--+> X軸
    0 150 300 450 600
```

### 5.2 封包傳輸順序
1. 每條Y軸掃描線產生兩個封包:
   - **d封包**: 包含X軸 0-299 的距離點
   - **e封包**: 包含X軸 300-599 的距離點

2. 同一Y軸線的d/e封包具有相同Frame ID

3. Y軸掃描按S型方式進行，角度從0到300+

### 5.3 數據重組
```python
# 偽代碼示例
def reconstruct_scan_line(d_packet, e_packet):
    if d_packet.frame_id == e_packet.frame_id:
        x_points_0_299 = parse_distances(d_packet.distance_data)
        x_points_300_599 = parse_distances(e_packet.distance_data)
        complete_line = x_points_0_299 + x_points_300_599
        return complete_line, d_packet.y_scan
```

---

## 6. 解析實現

### 6.1 封包識別
```python
def identify_packet_type(udp_payload):
    frame_id = udp_payload[0:2]  # 55aa (2字節)
    if frame_id == b'\x55\xaa':
        packet_type = chr(udp_payload[2])  # 第3字節
        y_scan = udp_payload[3]  # 第4字節
        return packet_type, y_scan
    return None, None
```

### 6.2 距離數據解析
```python
def parse_distance_data(distance_bytes):
    distances = []
    for i in range(0, len(distance_bytes), 4):
        if i + 3 < len(distance_bytes):
            # Little-endian讀取
            distance = int.from_bytes(
                distance_bytes[i:i+4], 
                byteorder='little'
            )
            if 0 < distance < 10000:  # 有效性檢查
                distances.append(distance)
            else:
                distances.append(None)  # 無效點
    return distances
```

### 6.3 Frame ID提取
```python
def extract_frame_id(udp_payload):
    frame_id_bytes = udp_payload[-4:]  # 最後4字節
    frame_id = int.from_bytes(frame_id_bytes, byteorder='little')
    return frame_id
```

---

## 7. 數據驗證

### 7.1 封包完整性檢查
- ✅ 幀標識符必須為 `0xAA55`
- ✅ 封包類型必須為 "d", "e", 或 "a"
- ✅ 距離數據必須為1200字節
- ✅ Y軸角度在合理範圍內 (0-300+)

### 7.2 距離數據驗證
- ✅ 距離值在有效範圍內 (0-10000 cm)
- ✅ 每條掃描線應有300個距離點
- ✅ d/e封包的Frame ID應該匹配

### 7.3 掃描邏輯驗證  
- ✅ S型掃描的Y軸角度遞增/遞減模式
- ✅ 同一Frame ID的d/e封包配對
- ✅ 完整的600×300點陣重建

---

## 8. 錯誤處理

### 8.1 常見錯誤
- **封包遺失**: d或e封包丟失導致掃描線不完整
- **Frame ID不匹配**: d/e封包的Frame ID不同
- **數據損壞**: 距離值超出有效範圍
- **順序錯亂**: 封包接收順序與掃描順序不符

### 8.2 處理策略
- **緩衝機制**: 暫存封包等待配對
- **超時處理**: 設定配對超時時間
- **插值修復**: 對無效距離點進行插值
- **重傳請求**: 檢測到錯誤時請求重傳

---

## 9. 性能考慮

### 9.1 處理速度
- **實時要求**: 必須能夠即時處理高頻率的封包流
- **緩衝管理**: 避免記憶體溢出
- **並行處理**: 可考慮多執行緒處理

### 9.2 記憶體使用
- **每個封包**: ~1.2KB
- **完整幀**: ~600KB (600×300×4字節)
- **緩衝區**: 建議預留多幀緩衝空間

---

## 10. 實際封包範例

### 10.1 distance1封包 (d類型)
```
幀標識符: aa55
封包類型: d1ed (d類型, Y軸237°)
Frame ID: 0500 (Frame 5)
距離數據: 300個距離點，每點4字節
```

### 10.2 distance2封包 (e類型)  
```
幀標識符: aa55
封包類型: e1ed (e類型, Y軸237°)
Frame ID: 0500 (Frame 5)
距離數據: 300個距離點，每點4字節
```

### 10.3 配對關係
- 兩個封包具有相同的Y軸角度 (237°)
- 兩個封包具有相同的Frame ID (5)
- 組合後形成完整的600點掃描線

---

## 11. 更新歷史

| 版本 | 日期 | 更新內容 |
|------|------|----------|
| 1.0 | 2025-05-17 | 初版，基於系統文件 |
| 2.0 | 2025-05-30 | 基於實際封包分析，修正規格 |

---

## 12. 附錄

### 12.1 相關文件
- `lidar_command_set.md` - LiDAR指令集參考
- `LidarControl.py` - 控制程式
- `LiDAR數據格式分析器.txt` - 數據分析工具

### 12.2 聯絡資訊
如有問題請參考系統文件或進行實際封包分析驗證。

---

**注意**: 本規格基於實際UDP封包分析結果，與理論規格可能略有差異。實際實現時請以本文件為準。